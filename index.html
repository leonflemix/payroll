<!-- Filename: index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Timecard Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #4f46e5; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .status-in { background-color: #10b981; }
        .status-out { background-color: #f59e0b; }
        .log-table th, .log-table td { padding: 8px 12px; text-align: left; }
        .log-table th { background-color: #e5e7eb; font-weight: 600; }
        .log-table tr:nth-child(even) { background-color: #f9fafb; }
        .log-table tr:hover { background-color: #f3f4f6; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); z-index: 50; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Auth Message Box (for transient messages) -->
    <div id="auth-message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg hidden transition duration-300"></div>

    <!-- Main Content Area -->
    <div id="app-container" class="w-full max-w-4xl">
        
        <!-- --------------------------------- -->
        <!-- VIEW: LOGIN -->
        <!-- --------------------------------- -->
        <div id="login_view" class="card p-8 w-full max-w-sm mx-auto transition-all duration-300" style="display:none;">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Timecard Kiosk Login</h1>
            <div class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="user@company.com">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                </div>
                <!-- handleLogin is attached via window.onload -->
                <button onclick="handleLogin()" class="w-full btn-primary px-4 py-2 rounded-lg font-semibold text-lg">Log In</button>
            </div>
            <p class="text-center text-xs text-gray-500 mt-6">
                Need to create a user? Ask the admin to use the Sign Up feature.
            </p>
        </div>

        <!-- --------------------------------- -->
        <!-- VIEW: KIOSK (EMPLOYEE DASHBOARD) -->
        <!-- --------------------------------- -->
        <div id="kiosk_view" class="card p-8 w-full max-w-lg mx-auto transition-all duration-300" style="display:none;">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Welcome, <span id="kiosk-employee-name"></span></h1>
                <button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-800"><i class="fas fa-sign-out-alt mr-1"></i> Logout</button>
            </div>

            <!-- Status and Action -->
            <div class="text-center mb-8">
                <div id="kiosk-status-badge" class="inline-block px-6 py-2 rounded-full text-white font-bold text-xl mb-4 transition-colors duration-300"></div>
                <!-- handleClockAction is attached via window.onload -->
                <button id="clock-action-btn" onclick="handleClockAction()" class="w-full py-4 rounded-lg font-extrabold text-white text-2xl shadow-lg transition-transform transform hover:scale-[1.01]"></button>
            </div>

            <!-- Recent Activity -->
            <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Activity (Last 5 Punches)</h2>
            <div id="recent-activity-list" class="space-y-2 text-sm">
                <!-- Log entries will be inserted here -->
            </div>
        </div>

        <!-- --------------------------------- -->
        <!-- VIEW: ADMIN DASHBOARD -->
        <!-- --------------------------------- -->
        <div id="admin_dashboard_view" class="w-full transition-all duration-300" style="display:none;">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
                <button onclick="handleLogout()" class="text-sm text-red-600 hover:text-red-800"><i class="fas fa-sign-out-alt mr-1"></i> Logout</button>
            </div>
            
            <!-- Admin Error Message -->
            <div id="admin-error-message" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 hidden font-medium" role="alert"></div>

            <!-- Admin Navigation Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" id="admin-tabs" role="tablist">
                    <!-- switchTab is attached via window.onload -->
                    <button onclick="switchTab('employee-management')" class="py-2 px-1 border-b-2 font-medium text-sm focus:outline-none transition duration-150 ease-in-out tab-button text-indigo-600 border-indigo-500" data-target="employee-management">Employee Management</button>
                    <button onclick="switchTab('log-management')" class="py-2 px-1 border-b-2 font-medium text-sm focus:outline-none transition duration-150 ease-in-out tab-button text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-target="log-management">Time Log Management</button>
                    <button onclick="switchTab('audit-history')" class="py-2 px-1 border-b-2 font-medium text-sm focus:outline-none transition duration-150 ease-in-out tab-button text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300" data-target="audit-history">Audit History</button>
                </nav>
            </div>

            <!-- TAB CONTENT: Employee Management -->
            <div id="employee-management" class="tab-content card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Employees</h2>
                    <button onclick="toggleSignupModal()" class="btn-primary px-3 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-plus mr-1"></i> Sign Up Employee</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 log-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2">Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Admin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employee-list-body" class="bg-white divide-y divide-gray-200">
                            <!-- Employee list rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB CONTENT: Time Log Management -->
            <div id="log-management" class="tab-content card p-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Time Logs</h2>
                
                <!-- Filters and Reports -->
                <div class="flex flex-wrap items-end space-y-4 md:space-y-0 md:space-x-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="w-full md:w-auto">
                        <label for="filter-employee-select" class="block text-xs font-medium text-gray-700">Filter Employee</label>
                        <select id="filter-employee-select" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- All Employees --</option>
                            <!-- Employee options populated here -->
                        </select>
                    </div>
                    <div class="w-full md:w-auto">
                        <label for="filter-start-date" class="block text-xs font-medium text-gray-700">Start Date</label>
                        <input type="date" id="filter-start-date" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="w-full md:w-auto">
                        <label for="filter-end-date" class="block text-xs font-medium text-gray-700">End Date</label>
                        <input type="date" id="filter-end-date" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="w-full md:w-auto">
                        <button onclick="applyFilters()" class="w-full md:w-auto btn-primary px-4 py-2 rounded-lg text-sm font-semibold">Apply Filters</button>
                    </div>
                    <div class="w-full md:w-auto">
                        <button onclick="generatePayrollReport()" class="w-full md:w-auto btn-success px-4 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-file-csv mr-1"></i> Generate Payroll Report</button>
                    </div>
                </div>

                <!-- Payroll Settings Toggle -->
                <div class="flex items-center space-x-2 mb-4">
                    <input type="checkbox" id="payroll-break-deductions" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="payroll-break-deductions" class="text-sm font-medium text-gray-700">Apply Per-Employee Break Deductions</label>
                </div>

                <!-- Log Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 log-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2">Employee</th>
                                <th>Date/Time</th>
                                <th>Type</th>
                                <th>Photo</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="time-log-list-body" class="bg-white divide-y divide-gray-200">
                            <!-- Time logs rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB CONTENT: Audit History -->
            <div id="audit-history" class="tab-content card p-6 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Last 10 Admin Changes</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 log-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2">Time</th>
                                <th>Admin User</th>
                                <th>Target Employee</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="audit-log-list-body" class="bg-white divide-y divide-gray-200">
                            <!-- Audit logs rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </div>
    
    <!-- --------------------------------- -->
    <!-- MODALS -->
    <!-- --------------------------------- -->

    <!-- Modal: Employee Sign Up / Edit Profile -->
    <div id="employee-signup-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card p-6 w-full max-w-md">
            <h2 id="signup-title" class="text-2xl font-bold mb-4">Sign Up New Employee</h2>
            <form id="employee-signup-form" onsubmit="handleEmployeeSignup(event)">
                <div class="space-y-4">
                    <input type="hidden" id="signup-uid">
                    <input type="text" id="signup-name" required placeholder="Full Name" class="w-full px-3 py-2 border rounded-lg">
                    <input type="email" id="signup-email" required placeholder="Email (Must be unique)" class="w-full px-3 py-2 border rounded-lg">
                    
                    <div id="signup-password-group">
                        <input type="password" id="signup-password-input" required placeholder="Password (Min 6 chars)" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeSignupModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Save Profile</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Employee Settings -->
    <div id="employee-settings-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card p-6 w-full max-w-md">
            <h2 id="settings-title" class="text-2xl font-bold mb-4">Edit Employee Settings</h2>
            <form id="employee-settings-form" onsubmit="handleEmployeeSettings(event)">
                <div class="space-y-4">
                    <input type="hidden" id="settings-uid">

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="settings-max-hours" class="block text-sm font-medium text-gray-700">Max Daily Regular Hrs</label>
                            <input type="number" id="settings-max-hours" required class="w-full px-3 py-2 border rounded-lg" min="1" step="0.5">
                        </div>
                        <div>
                            <label for="settings-break-mins" class="block text-sm font-medium text-gray-700">Break Deduction (Mins)</label>
                            <input type="number" id="settings-break-mins" required class="w-full px-3 py-2 border rounded-lg" min="0" step="1">
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <label for="settings-admin" class="text-sm font-medium text-gray-700">Is Admin?</label>
                        <input type="checkbox" id="settings-admin" class="rounded text-indigo-600">
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeSettingsModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Save Settings</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Time Log / Add Log -->
    <div id="log-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card p-6 w-full max-w-md">
            <h2 id="log-title" class="text-2xl font-bold mb-4">Edit Time Entry</h2>
            <form id="log-edit-form" onsubmit="handleLogSave(event)">
                <input type="hidden" id="log-id">
                <div class="space-y-4">
                    <div id="log-employee-group">
                        <label for="log-employee-select" class="block text-sm font-medium text-gray-700 mb-1">Employee</label>
                        <select id="log-employee-select" required class="w-full px-3 py-2 border rounded-lg">
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="log-datetime" class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                            <input type="datetime-local" id="log-datetime" required step="1" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="log-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select id="log-type" required class="w-full px-3 py-2 border rounded-lg">
                                <option value="in">Clock In</option>
                                <option value="out">Clock Out</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeLogModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Combined JavaScript Logic -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, Timestamp, updateDoc, setDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONSTANTS (from constants.js) ---

        // FALLBACK CONFIGURATION (from original constants.js)
        const HARDCODED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDkNNCV_5D9TpW3vhY2oTbnpGVCtlZC5n8",
            authDomain: "payroll-52d0b.firebaseapp.com",
            projectId: "payroll-52d0b",
            storageBucket: "payroll-52d0b.firebasestorage.app",
            messagingSenderId: "483678226011",
            appId: "1:483678226011:web:9ddbc595e4ec9e1325617e",
            measurementId: "G-SB0PVF2ZYV"
        };

        let FIREBASE_CONFIG = HARDCODED_FIREBASE_CONFIG;
        let APP_ID = FIREBASE_CONFIG.projectId || 'default-app-id';

        // 1. Try to read from Canvas environment (highest priority)
        if (typeof __firebase_config !== 'undefined') {
            try {
                FIREBASE_CONFIG = JSON.parse(__firebase_config);
                APP_ID = typeof __app_id !== 'undefined' ? __app_id : FIREBASE_CONFIG.projectId;
                console.log("Using Canvas Global Configuration.");
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
            }
        }
        
        // 2. Try to read from Vercel/Client-side injected Environment Variable
        // This assumes the Vercel build process injects the JSON string into the global window object.
        else if (typeof window.FIREBASE_CONFIG_JSON !== 'undefined' && typeof JSON.parse(window.FIREBASE_CONFIG_JSON).projectId !== 'undefined') {
            try {
                FIREBASE_CONFIG = JSON.parse(window.FIREBASE_CONFIG_JSON);
                APP_ID = FIREBASE_CONFIG.projectId;
                console.log("Using Vercel Injected Configuration.");
            } catch (e) {
                console.error("Error parsing window.FIREBASE_CONFIG_JSON:", e);
            }
        }
        
        // Final fallback uses HARDCODED_FIREBASE_CONFIG.
        
        const BASE_PATH = `artifacts/${APP_ID}/public/data`;
        const ADMIN_EMAIL = 'admin@kiosk.com'; // Email used for the Admin account

        // --- 2. STATE (from state.js) ---

        const state = {
            // Firebase Instances (set after initialization)
            db: null,
            auth: null,
            
            // Auth and User Data
            isAuthReady: false,
            currentUser: null, // Full employee document of the logged-in user
            
            // UI State
            currentView: 'login_view',
            
            // Data Caches
            allEmployees: {},
            allLogs: [],
            auditLogs: [],
            currentUserLogs: [],
            
            // Admin Filter State
            filterEmployeeUid: null,
            filterStartDate: null,
            filterEndDate: null,

            // Processing State
            isClocking: false,
            adminError: null,

            // Firestore paths (set dynamically in initFirebase)
            employee_path: '',
            timecards_logs_path: '',
            audit_logs_path: '',
        };

        function updateState(newState) {
            Object.assign(state, newState);
        }

        function setDb(dbInstance) {
            state.db = dbInstance;
        }

        function setAuth(authInstance) {
            state.auth = authInstance;
        }

        function setUserId(uid) {
            if (state.currentUser) {
                state.currentUser.uid = uid;
            }
        }

        function setAdminError(message) {
            state.adminError = message;
        }

        // --- 3. UTILITIES (from utils.js) ---

        function formatTimestamp(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
            const date = timestamp.toDate();
            const options = {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            };
            return date.toLocaleTimeString('en-US', options);
        }

        function formatTime(date) {
            if (!(date instanceof Date)) return 'N/A';
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            return date.toLocaleTimeString('en-US', options);
        }

        function formatTotalHours(hours) {
            if (typeof hours !== 'number' || isNaN(hours)) return '0.00';
            return hours.toFixed(2);
        }

        function calculateShiftTime(logEntry, employee) {
            if (!logEntry.timeIn || !logEntry.timeOut) {
                return { totalHours: 0, regularHours: 0, dailyOT: 0, weeklyOT: 0 };
            }

            const timeIn = logEntry.timeIn.getTime();
            const timeOut = logEntry.timeOut.getTime();
            
            let durationMs = timeOut - timeIn;
            if (durationMs < 0) durationMs = 0;

            let totalHours = durationMs / (1000 * 60 * 60);

            // Apply Break Deduction Logic (only if shift > 6 hours)
            const breakTriggerHours = 6;
            if (totalHours > breakTriggerHours) {
                // Deduction is applied only if the shift exceeds the trigger threshold
                totalHours -= (employee.breakDeductionMins / 60);
            }

            const maxDailyHours = employee.maxDailyHours || 8;
            let regularHours = totalHours;
            let dailyOT = 0;
            
            // Daily Overtime Calculation
            if (totalHours > maxDailyHours) {
                dailyOT = totalHours - maxDailyHours;
                regularHours = maxDailyHours;
            }

            return {
                totalHours: totalHours,
                regularHours: regularHours,
                dailyOT: dailyOT,
                weeklyOT: 0
            };
        }


        // --- 4. UI MODALS & MESSAGES (Helper functions that depend only on DOM) ---

        function closeSignupModal() {
            document.getElementById('employee-signup-modal').classList.add('hidden');
        }

        function closeLogModal() {
            document.getElementById('log-modal').classList.add('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('employee-settings-modal').classList.add('hidden');
        }

        function closeAllModals() {
            closeSignupModal();
            closeLogModal();
            closeSettingsModal();
        }

        /**
         * Sets a temporary message (e.g., success or error) in the Auth Status area.
         */
        function setAuthMessage(message, isError = false) {
            const authStatus = document.getElementById('auth-message-box');
            if (authStatus) {
                authStatus.textContent = message;
                authStatus.classList.remove('bg-green-200', 'bg-red-200', 'hidden');
                authStatus.classList.add(isError ? 'bg-red-200' : 'bg-green-200');

                // Clear the message after a delay
                setTimeout(() => {
                    renderUI(); // Re-render the UI to restore the default status message
                }, 5000);
            }
        }

        /**
         * Switches the active tab on the Admin Dashboard.
         */
        function switchTab(targetId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.getAttribute('data-target') === targetId) {
                    button.classList.remove('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                    button.classList.add('text-indigo-600', 'border-indigo-500');
                } else {
                    button.classList.remove('text-indigo-600', 'border-indigo-500');
                    button.classList.add('text-gray-500', 'border-transparent', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });
        }


        // --- 5. FIREBASE / DATA MANAGEMENT (Helper functions needed by Admin CRUD) ---

        /**
         * Writes an administrative action to the audit log collection.
         */
        async function writeAuditLog(action, details, targetUid, oldData = null) {
            if (!state.db || !state.currentUser) return;

            try {
                const auditCollection = collection(state.db, state.audit_logs_path);

                const logEntry = {
                    timestamp: Timestamp.now(),
                    adminUid: state.currentUser.uid,
                    adminName: state.currentUser.name || 'Admin',
                    action: action,
                    details: details,
                    targetUid: targetUid,
                    oldData: oldData,
                };

                await setDoc(doc(auditCollection), logEntry);
            } catch (error) {
                console.error("Failed to write audit log:", error);
            }
        }

        /**
         * Updates the employee's status after an admin edit/delete to ensure next punch is correct.
         */
        async function updateEmployeeStatusAfterLogEdit(employeeUid) {
            if (!state.db) return;

            try {
                const logsCollection = collection(state.db, state.timecards_logs_path);
                const q = query(
                    logsCollection,
                    where("employeeUid", "==", employeeUid),
                );

                const querySnapshot = await getDocs(q);
                let logsArray = [];

                querySnapshot.forEach(d => {
                    logsArray.push({ id: d.id, ...d.data() });
                });

                // Client-side sort to find the latest log
                logsArray.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

                const latestLog = logsArray.length > 0 ? logsArray[0] : null;

                // Status is the OPPOSITE of the latest log type
                const newStatus = latestLog ? (latestLog.type === 'in' ? 'out' : 'in') : 'out';

                const employeeRef = doc(state.db, state.employee_path, employeeUid);
                await updateDoc(employeeRef, { status: newStatus });

            } catch (error) {
                console.error("Error updating employee status after log edit:", error);
            }
        }


        // --- 6. CORE UI RENDERING (Functions that call data-dependent renders) ---

        /**
         * Renders the Time Log Management table, filtered by current admin settings.
         */
        function renderTimeLogList() {
            const tableBody = document.getElementById('time-log-list-body');
            const employeeFilter = document.getElementById('filter-employee-select');
            const startDateFilter = document.getElementById('filter-start-date');
            const endDateFilter = document.getElementById('filter-end-date');
            if (!tableBody || !state.allLogs || !state.allEmployees) return;

            // --- Populate Employee Filter Dropdown ---
            const currentFilterUid = employeeFilter.value;
            const employees = Object.values(state.allEmployees).sort((a, b) => a.name.localeCompare(b.name));
            employeeFilter.innerHTML = '<option value="">-- All Employees --</option>' + employees.map(emp =>
                `<option value="${emp.id}">${emp.name}</option>`
            ).join('');
            if (currentFilterUid) {
                employeeFilter.value = currentFilterUid;
            }


            // --- Apply Filtering ---
            let filteredLogs = state.allLogs;
            const employeeUid = employeeFilter.value;
            const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;

            if (employeeUid && employeeUid !== "") {
                filteredLogs = filteredLogs.filter(log => log.employeeUid === employeeUid);
            }

            if (startDate) {
                const startTimestamp = startDate.getTime();
                filteredLogs = filteredLogs.filter(log => log.timestamp.toMillis() >= startTimestamp);
            }

            if (endDate) {
                const endTimestamp = endDate.getTime() + 86400000; // Add 24 hours
                filteredLogs = filteredLogs.filter(log => log.timestamp.toMillis() < endTimestamp);
            }
            
            // Sort by timestamp descending (newest first)
            filteredLogs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            tableBody.innerHTML = filteredLogs.map(log => {
                const employee = state.allEmployees[log.employeeUid] || { name: 'Unknown', email: 'N/A' };
                const hasPhoto = !!log.photo; 

                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-3 font-medium text-gray-900">${employee.name}</td>
                        <td class="px-6 py-3 text-sm">${formatTimestamp(log.timestamp)}</td>
                        <td class="px-6 py-3">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${log.type === 'in' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${log.type.toUpperCase()}
                            </span>
                        </td>
                        <td class="px-6 py-3 text-center">
                            ${hasPhoto ? 
                                `<span class="text-green-600">Yes</span>` :
                                `<span class="inline-flex items-center text-red-500 text-sm">
                                    <i class="fas fa-camera-slash mr-1"></i>
                                    N/A
                                </span>`
                            }
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="toggleLogModal('${log.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                            <button onclick="handleLogDelete('${log.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (filteredLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No time logs found for the current filters.</td></tr>';
            }
        }

        /**
         * Renders the Employee Management table.
         */
        function renderEmployeeList() {
            const tableBody = document.getElementById('employee-list-body');
            if (!tableBody || !state.allEmployees) return;

            const employees = Object.values(state.allEmployees).sort((a, b) => a.name.localeCompare(b.name));

            tableBody.innerHTML = employees.map(emp => `
                <tr class="border-b hover:bg-gray-50 ${emp.isAdmin ? 'bg-yellow-50/50' : ''}">
                    <td class="px-6 py-3 font-medium text-gray-900">${emp.name}</td>
                    <td class="px-6 py-3 text-gray-600">${emp.email}</td>
                    <td class="px-6 py-3 text-sm text-center">
                        <span class="inline-flex items-center">
                            <span class="h-3 w-3 rounded-full mr-2 ${emp.status === 'in' ? 'bg-green-500' : 'bg-red-500'}"></span>
                            ${emp.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.isAdmin ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                            ${emp.isAdmin ? 'Admin' : 'Employee'}
                        </span>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="toggleSettingsModal('${emp.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit Settings</button>
                        <button onclick="toggleSignupModal('${emp.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit Name/Email</button>
                        <button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * Renders the Audit Log History table.
         */
        function renderAuditLogList() {
            const tableBody = document.getElementById('audit-log-list-body');
            if (!tableBody || !state.auditLogs || !state.allEmployees) return;

            // Sort by timestamp descending (newest first) and take the last 10
            const recentLogs = state.auditLogs
                .sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis())
                .slice(0, 10);

            tableBody.innerHTML = recentLogs.map(log => {
                const admin = state.allEmployees[log.adminUid] || { name: 'Unknown Admin' };
                const targetEmployee = state.allEmployees[log.targetUid] || { name: 'N/A' };
                const actionType = log.action.includes('EDIT') ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-3 text-sm">${formatTimestamp(log.timestamp)}</td>
                        <td class="px-6 py-3 font-medium text-gray-900">${admin.name}</td>
                        <td class="px-6 py-3 text-sm">${targetEmployee.name}</td>
                        <td class="px-6 py-3">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${actionType}">
                                ${log.action.replace('_', ' ')}
                            </span>
                        </td>
                        <td class="px-6 py-3 text-sm text-gray-600 truncate max-w-xs">${log.details}</td>
                    </tr>
                `;
            }).join('');
            
            if (recentLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No audit activity yet.</td></tr>';
            }
        }

        /**
         * Renders the employee Kiosk interface and recent activity.
         */
        function renderKiosk() {
            if (!state.currentUser) return;

            const kioskStatusBadge = document.getElementById('kiosk-status-badge');
            const clockButton = document.getElementById('clock-action-btn');
            const recentActivity = document.getElementById('recent-activity-list');
            const nameDisplay = document.getElementById('kiosk-employee-name');
            const currentStatus = state.currentUser.status || 'out';

            // Update Name and Status
            nameDisplay.textContent = state.currentUser.name;

            if (currentStatus === 'in') {
                kioskStatusBadge.textContent = 'Clocked In';
                kioskStatusBadge.classList.remove('bg-gray-200', 'bg-red-500');
                kioskStatusBadge.classList.add('bg-green-500', 'text-white');
                clockButton.textContent = 'Clock Out';
                clockButton.classList.remove('bg-green-500');
                clockButton.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                kioskStatusBadge.textContent = 'Clocked Out';
                kioskStatusBadge.classList.remove('bg-green-500', 'text-white');
                kioskStatusBadge.classList.add('bg-gray-200');
                clockButton.textContent = 'Clock In';
                clockButton.classList.remove('bg-red-500');
                clockButton.classList.add('bg-green-500', 'hover:bg-green-600');
            }

            // Disable button if currently processing a clock action
            clockButton.disabled = state.isClocking;

            // --- Render Recent Activity ---
            if (recentActivity && state.currentUserLogs) {
                recentActivity.innerHTML = state.currentUserLogs.map(log => `
                    <li class="flex justify-between items-center py-2 px-3 border-b last:border-b-0">
                        <span class="${log.type === 'in' ? 'text-green-600' : 'text-red-600'} font-semibold">${log.type.toUpperCase()}</span>
                        <span class="text-sm text-gray-600">${formatTimestamp(log.timestamp)}</span>
                    </li>
                `).join('');
                if (state.currentUserLogs.length === 0) {
                    recentActivity.innerHTML = '<li class="p-3 text-center text-gray-500">No recent activity.</li>';
                }
            }
        }


        /**
         * Main function to render the UI based on the current state.
         */
        function renderUI() {
            try {
                const views = ['login_view', 'kiosk_view', 'admin_dashboard_view'];
                
                // --- 1. View Switching ---
                views.forEach(viewId => {
                    const el = document.getElementById(viewId);
                    if (el) {
                        el.style.display = (viewId === state.currentView) ? 'block' : 'none';
                    }
                });

                // --- 2. Auth Status Message ---
                const authStatus = document.getElementById('auth-message-box');
                if (state.isAuthReady && state.currentUser) {
                    authStatus.textContent = `Signed in as: ${state.currentUser.email} (${state.currentUser.name})`;
                    authStatus.classList.remove('bg-red-200', 'hidden');
                    authStatus.classList.add('bg-green-200');
                } else if (state.isAuthReady) {
                    authStatus.textContent = `Please log in.`;
                    authStatus.classList.remove('bg-green-200', 'hidden');
                    authStatus.classList.add('bg-red-200');
                } else {
                    authStatus.textContent = `Connecting to Firebase...`;
                    authStatus.classList.remove('bg-red-200', 'bg-green-200', 'hidden');
                }


                // --- 3. View-Specific Rendering ---
                if (state.currentView === 'kiosk_view' && state.currentUser) {
                    renderKiosk();
                }

                if (state.currentView === 'admin_dashboard_view') {
                    // Admin Dashboard is built dynamically
                    renderEmployeeList();
                    renderTimeLogList();
                    renderAuditLogList();

                    // Display Admin Dashboard Error
                    const adminErrorEl = document.getElementById('admin-error-message');
                    if (state.adminError) {
                        adminErrorEl.textContent = `CRITICAL DATA ERROR: ${state.adminError}`;
                        adminErrorEl.classList.remove('hidden');
                    } else {
                        adminErrorEl.classList.add('hidden');
                    }
                }

            } catch (error) {
                console.error("FATAL UI RENDERING ERROR. App is unstable:", error);
            }
        }


        // --- 7. KIOSK LOGIC (Functions exposed to HTML) ---

        /**
         * Changes the current view in the application.
         */
        function navigateTo(targetView) {
            try {
                updateState({ currentView: targetView });
                renderUI(); // Call renderUI to switch view

            } catch (error) {
                console.error("CRITICAL NAVIGATION ERROR:", error);
            }
        }


        /**
         * Handles the employee and admin login process.
         */
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!state.auth) {
                setAuthMessage("Error: Application not fully initialized.", true);
                return;
            }

            try {
                setAuthMessage("Logging in...", false);
                await signInWithEmailAndPassword(state.auth, email, password);
                // Auth state listener handles successful login and navigation.

            } catch (error) {
                console.error("Login failed:", error);
                setAuthMessage(`Login failed: ${error.message.replace('Firebase: Error (auth/', '').replace(').', '')}`, true);
            }
        }

        /**
         * Handles the sign-out process.
         */
        async function handleLogout() {
            if (!state.auth) return;

            try {
                await signOut(state.auth);
                closeAllModals();
                
                // Navigation is handled by onAuthStateChanged
                setAuthMessage("You have been signed out.", false);
            } catch (error) {
                console.error("Logout failed:", error);
                setAuthMessage("Logout failed. Please try again.", true);
            }
        }

        /**
         * Handles the main clock in/out action handler.
         */
        async function handleClockAction() {
            if (!state.db || !state.currentUser || state.isClocking) {
                setAuthMessage("System error or busy. Please wait.", true);
                return;
            }

            const { status, uid, name } = state.currentUser;
            const type = status === 'in' ? 'out' : 'in';
            
            // Start processing state to prevent double-punching
            updateState({ isClocking: true }); 

            try {
                const timecardsCollection = collection(state.db, state.timecards_logs_path);

                const logEntry = {
                    employeeUid: uid,
                    employeeName: name, 
                    type: type,
                    timestamp: Timestamp.now(),
                    photo: null, // Camera removed, always set to null
                };

                await setDoc(doc(timecardsCollection), logEntry);

                // Update local status for immediate UI feedback
                updateState({
                    currentUser: {
                        ...state.currentUser,
                        status: type
                    },
                    isClocking: false // End processing state
                });
                    
                const successMessage = `Clock ${type.toUpperCase()} successful at ${new Date().toLocaleTimeString()}.`;
                setAuthMessage(successMessage, false);

            } catch (error) {
                console.error("Clock action failed:", error);
                setAuthMessage(`Clock action failed: ${error.message}`, true);
                updateState({ isClocking: false });
            }
        }


        // --- 8. ADMIN CRUD (Functions exposed to HTML) ---

        /**
         * Toggles the Employee Sign Up/Edit modal.
         */
        function toggleSignupModal(uid) {
            const modal = document.getElementById('employee-signup-modal');
            const form = document.getElementById('employee-signup-form');
            if (!modal || !form) return;

            // Reset form for new entry
            form.reset();
            document.getElementById('signup-title').textContent = 'Sign Up New Employee';
            document.getElementById('signup-password-group').classList.remove('hidden');
            document.getElementById('signup-uid').value = '';
            document.getElementById('signup-password-input').required = true;

            if (uid && state.allEmployees[uid]) {
                const emp = state.allEmployees[uid];
                document.getElementById('signup-title').textContent = 'Edit Employee Profile';
                document.getElementById('signup-name').value = emp.name;
                document.getElementById('signup-email').value = emp.email;
                document.getElementById('signup-uid').value = uid; // Hidden field to track the user being edited
                document.getElementById('signup-password-group').classList.add('hidden');
                document.getElementById('signup-password-input').required = false;
            }

            modal.classList.remove('hidden');
        }

        /**
         * Handles the submission of the employee sign up/edit form.
         */
        async function handleEmployeeSignup(event) {
            event.preventDefault();
            closeAllModals();

            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password-input').value;
            const uid = document.getElementById('signup-uid').value; // Check for existing UID

            if (uid) {
                // --- Edit Existing Employee ---
                try {
                    const employeeRef = doc(state.db, state.employee_path, uid);
                    await setDoc(employeeRef, { name, email }, { merge: true });

                    await writeAuditLog('EDIT_PROFILE', `Updated name/email for ${name}`, uid);
                    setAuthMessage(`Successfully updated profile for ${name}.`, false);
                } catch (error) {
                    console.error("Error updating employee profile:", error);
                    setAuthMessage(`Failed to update profile: ${error.message}`, true);
                }
            } else {
                // --- Sign Up New Employee (Requires Auth + Firestore Doc) ---
                if (password.length < 6) {
                    setAuthMessage("Password must be at least 6 characters.", true);
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(state.auth, email, password);
                    const newUid = userCredential.user.uid;
                    const employeeRef = doc(state.db, state.employee_path, newUid);

                    const initialData = {
                        uid: newUid,
                        name: name,
                        email: email,
                        isAdmin: false,
                        status: 'out',
                        maxDailyHours: 8,
                        breakDeductionMins: 30
                    };

                    await setDoc(employeeRef, initialData); 

                    await writeAuditLog('CREATE_USER', `Created new employee: ${name}`, newUid);
                    setAuthMessage(`Employee ${name} created successfully!`, false);
                } catch (error) {
                    console.error("Error creating new employee:", error);
                    setAuthMessage(`Sign Up failed: ${error.message}`, true);
                }
            }
        }

        /**
         * Toggles the Employee Settings modal.
         */
        function toggleSettingsModal(uid) {
            const modal = document.getElementById('employee-settings-modal');
            const form = document.getElementById('employee-settings-form');
            if (!modal || !form || !state.allEmployees[uid]) return;

            const emp = state.allEmployees[uid];

            document.getElementById('settings-title').textContent = `Edit Settings: ${emp.name}`;
            document.getElementById('settings-uid').value = uid;
            document.getElementById('settings-admin').checked = emp.isAdmin;
            document.getElementById('settings-max-hours').value = emp.maxDailyHours || 8;
            document.getElementById('settings-break-mins').value = emp.breakDeductionMins || 30;

            modal.classList.remove('hidden');
        }

        /**
         * Handles the submission of the employee settings form.
         */
        async function handleEmployeeSettings(event) {
            event.preventDefault();
            closeAllModals();

            const uid = document.getElementById('settings-uid').value;
            const isAdmin = document.getElementById('settings-admin').checked;
            const maxDailyHours = parseFloat(document.getElementById('settings-max-hours').value);
            const breakDeductionMins = parseInt(document.getElementById('settings-break-mins').value, 10);

            const emp = state.allEmployees[uid];

            if (!emp) {
                setAuthMessage("Error: Employee not found.", true);
                return;
            }

            try {
                const employeeRef = doc(state.db, state.employee_path, uid);
                const updates = {
                    isAdmin,
                    maxDailyHours,
                    breakDeductionMins
                };

                await setDoc(employeeRef, updates, { merge: true });
                await writeAuditLog('EDIT_SETTINGS', `Updated settings for ${emp.name}`, uid, JSON.stringify(updates));
                setAuthMessage(`Successfully updated settings for ${emp.name}.`, false);

            } catch (error) {
                console.error("Error updating employee settings:", error);
                setAuthMessage(`Failed to update settings: ${error.message}`, true);
            }
        }


        /**
         * Deletes an employee from Firestore (does not delete Auth user).
         */
        async function deleteEmployee(uid) {
            const employee = state.allEmployees[uid];
            if (!employee) {
                setAuthMessage("Error: Employee not found.", true);
                return;
            }

            try {
                // 1. Delete Firestore Document
                const employeeRef = doc(state.db, state.employee_path, uid);
                await deleteDoc(employeeRef);

                await writeAuditLog('DELETE_PROFILE', `Deleted employee profile for ${employee.name}`, uid, JSON.stringify(employee));
                setAuthMessage(`Employee ${employee.name} profile deleted. NOTE: Firebase Auth user is NOT deleted.`, false);
            } catch (error) {
                console.error("Error deleting employee:", error);
                setAuthMessage(`Failed to delete employee: ${error.message}`, true);
            }
        }

        /**
         * Toggles the Log Edit/Add modal.
         */
        function toggleLogModal(logId) {
            const modal = document.getElementById('log-modal');
            const form = document.getElementById('log-edit-form');
            if (!modal || !form || !state.allEmployees) return;

            // Reset form
            form.reset();
            document.getElementById('log-title').textContent = 'Add New Time Log';
            document.getElementById('log-id').value = '';
            document.getElementById('log-employee-select').disabled = false;

            // Populate Employee Select
            const employeeSelect = document.getElementById('log-employee-select');
            const employees = Object.values(state.allEmployees).sort((a, b) => a.name.localeCompare(b.name));
            employeeSelect.innerHTML = employees.map(emp =>
                `<option value="${emp.id}">${emp.name}</option>`
            ).join('');


            if (logId) {
                // --- Edit Existing Log ---
                const log = state.allLogs.find(l => l.id === logId);
                if (!log) return;

                document.getElementById('log-title').textContent = 'Edit Time Log';
                document.getElementById('log-id').value = log.id;
                document.getElementById('log-employee-select').value = log.employeeUid;
                document.getElementById('log-employee-select').disabled = true; // Cannot change employee of an existing log

                // Format timestamp for datetime-local input
                const date = log.timestamp.toDate();
                const datePart = date.toISOString().substring(0, 10);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                const timePart = `${hours}:${minutes}:${seconds}`;

                document.getElementById('log-datetime').value = `${datePart}T${timePart}`;
                document.getElementById('log-type').value = log.type;

            } else {
                // Default values for new log
                const now = new Date();
                const datePart = now.toISOString().substring(0, 10);
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const timePart = `${hours}:${minutes}:${seconds}`;
                
                document.getElementById('log-datetime').value = `${datePart}T${timePart}`;
                document.getElementById('log-type').value = 'in';
            }

            modal.classList.remove('hidden');
        }

        /**
         * Handles the submission of the log edit/add form.
         */
        async function handleLogSave(event) {
            event.preventDefault();
            closeAllModals();

            const logId = document.getElementById('log-id').value;
            const employeeUid = document.getElementById('log-employee-select').value;
            const datetime = document.getElementById('log-datetime').value;
            const type = document.getElementById('log-type').value;

            if (!employeeUid || !datetime || !type) {
                setAuthMessage("All fields are required.", true);
                return;
            }

            const newTimestamp = Timestamp.fromDate(new Date(datetime));

            try {
                if (logId) {
                    // --- Edit Existing Log ---
                    const log = state.allLogs.find(l => l.id === logId);
                    if (!log) throw new Error("Log record not found.");

                    const oldDetails = JSON.stringify({ oldTime: formatTimestamp(log.timestamp), oldType: log.type });
                    const logRef = doc(state.db, state.timecards_logs_path, logId);

                    await updateDoc(logRef, {
                        timestamp: newTimestamp,
                        type: type
                    });

                    const newDetails = JSON.stringify({ newTime: formatTimestamp(newTimestamp), newType: type });
                    await writeAuditLog('EDIT_LOG', `Time log edited by Admin. Old: ${oldDetails} New: ${newDetails}`, log.employeeUid);
                    
                    await updateEmployeeStatusAfterLogEdit(employeeUid);
                    setAuthMessage("Time log updated successfully.", false);

                } else {
                    // --- Add New Log ---
                    const logsCollection = collection(state.db, state.timecards_logs_path);
                    
                    const employee = state.allEmployees[employeeUid];
                    if (!employee) throw new Error("Employee data not found.");

                    const logRef = doc(logsCollection); 
                    
                    const newLog = {
                        employeeUid: employeeUid,
                        employeeName: employee.name, 
                        type: type,
                        timestamp: newTimestamp,
                        photo: null 
                    };

                    await setDoc(logRef, newLog);

                    await writeAuditLog('ADD_LOG', `New log added by Admin: ${type} at ${formatTimestamp(newTimestamp)}`, employeeUid);
                    
                    await updateEmployeeStatusAfterLogEdit(employeeUid);
                    setAuthMessage("New time log added successfully.", false);
                }
            } catch (error) {
                console.error("Error saving time log:", error);
                setAuthMessage(`Failed to save log: ${error.message}`, true);
            }
        }

        /**
         * Deletes a time log entry.
         */
        async function handleLogDelete(logId) {
            const log = state.allLogs.find(l => l.id === logId);
            if (!log) {
                setAuthMessage("Error: Log record not found.", true);
                return;
            }

            try {
                const logRef = doc(state.db, state.timecards_logs_path, logId);
                await deleteDoc(logRef);

                await writeAuditLog('DELETE_LOG', `Deleted log: ${log.type} at ${formatTimestamp(log.timestamp)}`, log.employeeUid, JSON.stringify(log));
                
                await updateEmployeeStatusAfterLogEdit(log.employeeUid);
                setAuthMessage("Time log deleted.", false);
            } catch (error) {
                console.error("Error deleting log:", error);
                setAuthMessage(`Failed to delete log: ${error.message}`, true);
            }
        }

        /**
         * Re-renders the time log list when filters are changed.
         */
        function applyFilters() {
            renderTimeLogList();
        }


        /**
         * Generates and downloads a CSV file based on the currently filtered logs.
         */
        async function generatePayrollReport() {
            closeAllModals();

            if (!state.allLogs || !state.allEmployees) {
                setAuthMessage("Error: Data not fully loaded.", true);
                return;
            }

            const applyDeductions = document.getElementById('payroll-break-deductions').checked;

            const startDateFilter = document.getElementById('filter-start-date');
            const endDateFilter = document.getElementById('filter-end-date');
            const employeeFilter = document.getElementById('filter-employee-select'); 

            const employeeUid = employeeFilter.value || null;

            let filteredLogs = state.allLogs;

            if (employeeUid && employeeUid !== "") {
                filteredLogs = filteredLogs.filter(log => log.employeeUid === employeeUid);
            }

            const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;

            if (startDate) {
                const startTimestamp = startDate.getTime();
                filteredLogs = filteredLogs.filter(log => log.timestamp.toMillis() >= startTimestamp);
            }

            if (endDate) {
                const endTimestamp = endDate.getTime() + 86400000; // Add 24 hours
                filteredLogs = filteredLogs.filter(log => log.timestamp.toMillis() < endTimestamp);
            }

            filteredLogs.sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis());


            // --- 1. Pair Punches and Calculate Shifts ---
            const shifts = [];
            const unpairedPunches = [];

            for (let i = 0; i < filteredLogs.length; i++) {
                const current = filteredLogs[i];

                if (current.type === 'in') {
                    const nextOutIndex = filteredLogs.findIndex((next, j) => j > i && next.type === 'out' && next.employeeUid === current.employeeUid);

                    if (nextOutIndex !== -1) {
                        const nextOut = filteredLogs[nextOutIndex];
                        const shiftDurationMs = nextOut.timestamp.toMillis() - current.timestamp.toMillis();
                        const shiftHours = shiftDurationMs / 3600000;

                        const employee = state.allEmployees[current.employeeUid];
                        const maxDailyHours = employee?.maxDailyHours || 8;
                        const breakDeductionMins = (applyDeductions ? employee?.breakDeductionMins : 0) || 0; 

                        shifts.push({
                            employeeUid: current.employeeUid,
                            name: employee.name,
                            in: current.timestamp.toDate(),
                            out: nextOut.timestamp.toDate(),
                            shiftHours: shiftHours,
                            maxDailyHours: maxDailyHours,
                            breakDeductionMins: breakDeductionMins,
                            date: current.timestamp.toDate().toDateString()
                        });
                        i = nextOutIndex;
                    } else {
                        unpairedPunches.push(current);
                    }
                } else {
                    unpairedPunches.push(current);
                }
            }

            // --- 2. Calculate Overtime (Daily and Weekly) ---
            const finalReport = [];
            const weeklyHours = {}; 

            for (const shift of shifts) {
                let grossHours = shift.shiftHours;
                
                const breakTriggerHours = 6;
                const breakDeductionHours = (shift.breakDeductionMins > 0 && grossHours > breakTriggerHours) ? (shift.breakDeductionMins / 60) : 0;
                let netHours = grossHours - breakDeductionHours;

                let regularHours = 0;
                let dailyOvertime = 0;
                let weeklyOvertime = 0;

                // Daily Overtime Calculation
                const dailyLimit = shift.maxDailyHours;
                if (netHours > dailyLimit) {
                    dailyOvertime = netHours - dailyLimit;
                }

                let hoursForWeeklySplit = netHours - dailyOvertime; 

                // Weekly Overtime 
                const shiftDate = shift.in;
                const dayOfWeek = shiftDate.getDay(); 
                const daysToSubtract = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
                
                const startOfWeek = new Date(shiftDate);
                startOfWeek.setDate(shiftDate.getDate() - daysToSubtract); 
                startOfWeek.setHours(0, 0, 0, 0);
                const weekKey = `${shift.employeeUid}-${startOfWeek.getTime()}`; 

                if (!weeklyHours[weekKey]) {
                    weeklyHours[weekKey] = { totalHours: 0, regularCapacity: 40 }; 
                }
                
                const currentWeeklyTotal = weeklyHours[weekKey].totalHours; 
                const remainingRegularCapacity = weeklyHours[weekKey].regularCapacity - currentWeeklyTotal;
                
                if (remainingRegularCapacity > 0) {
                    const hoursForRegular = Math.min(hoursForWeeklySplit, remainingRegularCapacity);
                    regularHours = hoursForRegular;
                    weeklyOvertime = hoursForWeeklySplit - hoursForRegular;
                } else {
                    weeklyOvertime = hoursForWeeklySplit;
                }

                weeklyHours[weekKey].totalHours += hoursForWeeklySplit;


                finalReport.push({
                    name: shift.name,
                    date: shift.date,
                    inTime: formatTime(shift.in),
                    outTime: formatTime(shift.out),
                    grossHours: formatTotalHours(shift.shiftHours),
                    breakDeduction: formatTotalHours(breakDeductionHours),
                    netHours: formatTotalHours(shift.shiftHours - breakDeductionHours),
                    regularHours: formatTotalHours(regularHours),
                    dailyOvertime: formatTotalHours(dailyOvertime),
                    weeklyOvertime: formatTotalHours(weeklyOvertime),
                    notes: (breakDeductionHours > 0) ? `Break deducted: ${shift.breakDeductionMins}m` : ''
                });
            }

            // --- 3. Generate CSV Content ---
            let csv = "Employee,Date,Clock In,Clock Out,Gross Hours,Break Deduction,Net Hours,Regular Hours,Daily OT,Weekly OT,Notes\n";
            finalReport.forEach(row => {
                csv += `${row.name},${row.date},${row.inTime},${row.outTime},${row.grossHours},${row.breakDeduction},${row.netHours},${row.regularHours},${row.dailyOvertime},${row.weeklyOvertime},"${row.notes}"\n`;
            });

            if (unpairedPunches.length > 0) {
                csv += "\n\n--- UNPAIRED PUNCHEES (Review Required) ---\n";
                csv += "Employee,Date/Time,Type\n";
                unpairedPunches.forEach(log => {
                    const employee = state.allEmployees[log.employeeUid] || { name: 'Unknown' };
                    csv += `${employee.name},${formatTimestamp(log.timestamp)},${log.type.toUpperCase()}\n`;
                });
            }

            // --- 4. Download CSV ---
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `payroll_report_${new Date().toISOString().substring(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            setAuthMessage("Payroll report generated successfully.", false);
        }


        // --- 9. CORE FIREBASE LISTENERS / INIT ---

        /**
         * Listener for the current employee's recent activity (Kiosk View).
         */
        function listenToUserLogs(uid) {
            if (!state.db || !uid) return;

            try {
                const logsCollection = collection(state.db, state.timecards_logs_path);
                const logsQuery = query(
                    logsCollection,
                    where("employeeUid", "==", uid),
                );

                onSnapshot(logsQuery, (snapshot) => {
                    const logs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    logs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                    updateState({ currentUserLogs: logs.slice(0, 5) });
                    renderUI();
                }, (error) => {
                    console.error(`[FATAL KIOSK LISTENER ERROR - User Logs for ${uid}]:`, error);
                });

            } catch (e) {
                console.error("Error initializing user log listener:", e);
            }
        }


        /**
         * Initializes all admin-level real-time listeners for dashboard data.
         */
        function listenToAllData() {
            if (!state.db) return;
            setAdminError(null);

            try {
                // 1. Employees Listener
                onSnapshot(collection(state.db, state.employee_path), (snapshot) => {
                    const employees = {};
                    snapshot.docs.forEach(d => {
                        employees[d.id] = { id: d.id, ...d.data(), email: d.data().email || 'N/A' };
                    });
                    updateState({ allEmployees: employees });
                    renderUI();
                }, (error) => {
                    setAdminError("Employee Load Failed: " + error.message);
                    console.error(`[FATAL ADMIN LISTENER ERROR - All Employees]:`, error);
                    renderUI();
                });

                // 2. All Time Logs Listener
                onSnapshot(collection(state.db, state.timecards_logs_path), (snapshot) => {
                    updateState({ allLogs: snapshot.docs.map(d => ({ id: d.id, ...d.data() })) });
                    setAdminError(null);
                    renderUI();
                }, (error) => {
                    setAdminError("Time Log Load Failed: " + error.message);
                    console.error(`[FATAL ADMIN LISTENER ERROR - All Logs]:`, error);
                    renderUI();
                });

                // 3. Audit Logs Listener
                const auditQuery = query(collection(state.db, state.audit_logs_path));
                onSnapshot(auditQuery, (snapshot) => {
                    const auditLogs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    auditLogs.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                    updateState({ auditLogs: auditLogs.slice(0, 10) });
                    setAdminError(null);
                    renderUI();
                }, (error) => {
                    setAdminError("Audit Log Load Failed: " + error.message);
                    console.error(`[FATAL ADMIN LISTENER ERROR - Audit Logs]:`, error);
                    renderUI();
                });

            } catch (e) {
                console.error("Error initializing Admin listeners:", e);
                setAdminError("Critical data listener initialization failed.");
                renderUI();
            }
        }

        /**
         * Fetches the current user's profile from Firestore and updates global state.
         */
        async function fetchAndSetCurrentUser(user) {
            if (!state.db) return;

            try {
                const docRef = doc(state.db, state.employee_path, user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const userData = { ...docSnap.data(), uid: user.uid, email: user.email };
                    updateState({ currentUser: userData });
                    setUserId(user.uid);

                    if (userData.isAdmin) {
                        listenToAllData();
                    } else {
                        listenToUserLogs(user.uid);
                    }

                    navigateTo(userData.isAdmin ? 'admin_dashboard_view' : 'kiosk_view');

                } else if (user.isAnonymous) {
                    updateState({ currentUser: null });
                    navigateTo('login_view');
                } else {
                    console.error(`CRITICAL ERROR: User profile document missing for Auth UID: ${user.uid}. Logging out.`);
                    setAuthMessage("Profile not found. Contact administrator.", true);
                    await signOut(state.auth);
                }
            } catch (error) {
                console.error("Fatal error fetching user data, logging out:", error);
                setAuthMessage(`Data Error: ${error.message}. Logging out.`, true);
                await signOut(state.auth);
            }
        }

        /**
         * Initializes Firebase App, Auth, and Firestore services.
         */
        async function initFirebase() {
            console.log("Initializing Firebase...");
            try {
                setLogLevel('debug');
                
                const app = initializeApp(FIREBASE_CONFIG);
                const dbInstance = getFirestore(app);
                const authInstance = getAuth(app);

                setDb(dbInstance);
                setAuth(authInstance);

                const pathRoot = BASE_PATH;
                updateState({
                    employee_path: `${pathRoot}/employees`,
                    timecards_logs_path: `${pathRoot}/time_logs`,
                    audit_logs_path: `${pathRoot}/audit_logs`
                });

                // MANDATORY CANVAS AUTHENTICATION
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(authInstance, __initial_auth_token);
                    console.log("Signed in with Custom Token.");
                } else {
                    await signInAnonymously(authInstance);
                    console.log("Signed in Anonymously.");
                }

                onAuthStateChanged(authInstance, (user) => {
                    updateState({ isAuthReady: true });
                    if (user && user.uid) {
                        console.log(`Auth state changed. User UID: ${user.uid}`);
                        fetchAndSetCurrentUser(user);
                    } else {
                        updateState({ currentUser: null });
                        setUserId(null);
                        navigateTo('login_view');
                        renderUI();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                setAuthMessage(`Initialization Failed: ${error.message}`, true);
            }
        }


        // --- 10. MAIN INIT (Expose to window and start) ---

        window.onload = function() {
            // Expose all necessary functions to the global scope for HTML onclick events
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            window.handleClockAction = handleClockAction;
            window.toggleSignupModal = toggleSignupModal;
            window.handleEmployeeSignup = handleEmployeeSignup;
            window.deleteEmployee = deleteEmployee;
            window.toggleLogModal = toggleLogModal;
            window.handleLogSave = handleLogSave;
            window.handleLogDelete = handleLogDelete;
            window.generatePayrollReport = generatePayrollReport;
            window.toggleSettingsModal = toggleSettingsModal;
            window.handleEmployeeSettings = handleEmployeeSettings;
            window.applyFilters = applyFilters;
            window.switchTab = switchTab;
            window.closeSignupModal = closeSignupModal;
            window.closeLogModal = closeLogModal;
            window.closeSettingsModal = closeSettingsModal;
            window.closeAllModals = closeAllModals;
            
            // Start the application initialization
            initFirebase();
        };

    </script>
</body>
</html>